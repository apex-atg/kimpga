<!DOCTYPE html> 
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>김프 자동매매 시스템 · Pro Dashboard+ (Multi-Band / Queue)</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0b0f17; --panel:#0f1522; --panel-2:#0c1320; --text:#e7ecf5; --muted:#98a3b7;
      --primary:#00e0c7; --primary-2:#14b8a6; --accent:#7aa2ff; --accent-2:#60a5fa;
      --danger:#ff5570; --warn:#ffb020; --ok:#22c55e; --border:#1b2536; --chip:#111a29;
      --shadow:0 10px 30px rgba(0,0,0,.45); --radius:14px; --ring:0 0 0 3px rgba(122,162,255,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--text);
      background:
        radial-gradient(1200px 600px at 80% -20%, rgba(0,224,199,.07), transparent 60%),
        radial-gradient(1000px 500px at 10% -10%, rgba(122,162,255,.07), transparent 60%),
        linear-gradient(180deg,#0a0e16 0%, var(--bg) 100%);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Apple SD Gothic Neo', 'Noto Sans KR', 'Noto Sans', sans-serif;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;}
    header{position:sticky; top:0; z-index:40; backdrop-filter:blur(10px) saturate(160%); background:rgba(8,12,20,.65); border-bottom:1px solid var(--border)}
    .nav{max-width:1220px; margin:0 auto; padding:12px 18px; display:flex; align-items:center; gap:14px}
    .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.2px}
    .logo{width:30px; height:30px; display:inline-grid; place-items:center; border-radius:10px;
      background:conic-gradient(from 210deg, var(--primary), #6ee7b7, #22d3ee, var(--accent));
      color:#03121a; font-weight:900; box-shadow:0 0 0 4px rgba(0,224,199,.08)}
    .sub{color:var(--muted); font-size:12px}
    .chip{background:linear-gradient(180deg,#0e1728,#0a1220); color:#cbd5e1; border:1px solid var(--border);
      padding:6px 10px; border-radius:999px; font-size:12px; display:inline-flex; align-items:center; gap:8px}
    .dot{width:7px; height:7px; border-radius:50%; background:#94a3b8; box-shadow:0 0 0 2px rgba(148,163,184,.15)}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.danger{background:var(--danger)}
    .grow{flex:1}
    .kimp-brief{font-size:13px; color:var(--muted); font-variant-numeric:tabular-nums}

    .wrap{max-width:1220px; margin:22px auto; padding:0 18px}
    .grid{display:grid; gap:18px; grid-template-columns:repeat(12,1fr)}
    .col-6{grid-column:span 6} .col-12{grid-column:span 12}
    @media (max-width:1024px){.col-6{grid-column:span 12}}

    .card{background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%);
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px}
    .card h3{margin:0 0 10px 0; font-size:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    label{display:block; font-size:12px; color:#aab3c7; margin-bottom:6px}
    .ctrl{background:#0b1220; border:1px solid #1e293b; color:#dbe6ff; border-radius:10px; width:100%; padding:10px 12px; outline:none; font-variant-numeric:tabular-nums}
    .ctrl:focus{border-color:#274674; box-shadow:var(--ring)}
    .hint{font-size:12px; color:#aab3c7; margin-top:6px}
    .btn{appearance:none; border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:800;
      background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#051018; transition:transform .05s ease, box-shadow .15s ease;
      box-shadow:0 6px 18px rgba(0,224,199,.15)}
    .btn:hover{box-shadow:0 8px 24px rgba(0,224,199,.22)} .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#122036; color:#e2e8f0; border:1px solid #22324b; box-shadow:none}
    .btn.ghost{background:transparent; border:1px dashed #334155; color:#aab3b7; box-shadow:none}
    .btn.preset{padding:6px 10px; border-radius:999px; background:#10192b; color:#cbd5e1; border:1px solid #24324a}

    .kv{display:grid; grid-template-columns:150px 1fr; gap:6px; font-size:14px}
    .kv b{color:#c9d5ea}
    .hl{color:var(--primary)}
    .mono{font-variant-numeric:tabular-nums; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .muted{color:#aab3c7}

    .tabs{display:flex; gap:6px; border-bottom:1px solid var(--border); margin-bottom:10px}
    .tab.active{background:#0a1220; color:#dbe6ff}
    .tab{padding:8px 12px; border-radius:10px 10px 0 0; cursor:pointer; background:#0d1729; color:#aab3c7; border:1px solid var(--border); border-bottom:none}
    .panel{display:none} .panel.active{display:block}

    .log{background:#05080f; color:#cdebd7; border:1px solid var(--1b2a3b); padding:12px; border-radius:10px; height:360px; overflow:auto;
      font:12px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; white-space:pre}

    .badge{padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:#0b1320}
    .badge.good{color:var(--ok); border-color:rgba(34,197,94,.3)}
    .badge.bad{color:var(--danger); border-color:rgba(255,85,112,.3)}
    .badge.warn{color:var(--warn); border-color:rgba(255,176,32,.3)}

    .spark{width:100%; height:54px; display:block; background:#0a1220; border:1px solid #1b2a3b; border-radius:10px}
    .spark-wrap{display:grid; grid-template-columns:1fr 90px; gap:10px; align-items:center}
    .spark-val{text-align:right; font-weight:800}

    table{border-collapse:separate; border-spacing:0 6px; width:100%}
    thead th{font-size:12px; color:#aab3c7; text-align:left; padding:6px 8px}
    tbody td{padding:6px 8px}

    .circle-wrap{display:flex; gap:12px; align-items:center}
    .circle{display:grid; place-items:center; border-radius:999px; border:1px solid var(--border); background:#0a1220; box-shadow:var(--shadow)}
    .circle small{display:block; font-size:10px; color:#9db0d0}
    .circle strong{font-size:12px}
  </style>

  <!-- 업비트 WebSocket 응답(MessagePack) 디코딩용 -->
  <script src="https://unpkg.com/@msgpack/msgpack/dist/msgpack.min.js"></script>
</head>
<body>
<header>
  <div class="nav">
    <div class="brand">
      <div class="logo" aria-hidden="true">₿</div>
      <div>
        김치프리미엄 자동매매<br/>
        <span class="sub">Pro Dashboard+ · Multi-Band + Queue (강제진입 없음)</span>
      </div>
    </div>

    <span id="run-badge" class="chip" title="전략 실행 상태"><i class="dot"></i><span>상태 확인중…</span></span>
    <span id="arm-badge" class="chip" title="진입 정책"><i class="dot ok"></i><span>조건 충족 시 자동 대기→진입</span></span>
    <span class="chip" title="수수료 기준"><i class="dot ok"></i>추정 비용 ≈ 0.18%p</span>
    <span id="net-badge" class="chip" title="네트워크 상태"><i class="dot"></i><span>NET …</span></span>

    <div class="grow"></div>
    <div id="kimp-brief" class="kimp-brief mono" aria-live="polite">-</div>
  </div>
</header>
<div class="wrap">
  <div class="grid">
    <!-- 전략 설정: 멀티 밴드 -->
    <section class="card col-12">
      <h3>전략 설정 (멀티 밴드)</h3>
      <div class="row" style="gap:6px; margin-bottom:8px">
        <button class="btn ghost" id="btn-add-band">밴드 추가</button>
        <button class="btn ghost" id="btn-save">설정 저장(로컬)</button>
        <button class="btn ghost" id="btn-load">불러오기</button>
      </div>

      <div style="margin-top:12px; overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="min-width:90px">이름</th>
              <th style="min-width:120px">진입 김프율(%)</th>
              <th style="min-width:120px">청산 김프율(%)</th>
              <th style="min-width:120px">허용오차(%)</th>
              <th style="min-width:120px">레버리지</th>
              <th style="min-width:150px">투자수량(BTC)</th>
              <th style="min-width:220px">미리보기 (Upbit KRW / Binance USDT)</th>
              <th style="min-width:130px">상태</th>
              <th style="min-width:220px">서버</th>
              <th style="min-width:80px">삭제</th>
            </tr>
          </thead>
          <tbody id="band-tbody"></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="btn-start">▶ 전략 시작</button>
        <button class="btn secondary" id="btn-stop">■ 전략 중지</button>
      </div>
      <p class="hint">※ 이 UI는 <b>강제 진입이 없습니다.</b> 각 밴드는 <b>entry_kimp±tolerance</b> 범위에 <b>도달하면 자동 진입</b>, 이후 <b>exit_kimp</b> 등 조건 충족 시 자동 청산됩니다.</p>
    </section>

    <!-- 시장 스냅샷 -->
    <section class="card col-6">
      <h3>시장 스냅샷</h3>
      <div class="grid" style="gap:12px; grid-template-columns: repeat(12, 1fr);">
        <div class="col-6">
          <div class="kv">
            <b>김프</b><span><span id="kimp" class="mono" style="font-weight:800">-</span> <span id="kimp-sign" class="badge">-</span></span>
            <b>업비트</b><span class="mono" id="upbit_price">-</span>
            <b>바이낸스</b><span class="mono" id="binance_price">-</span>
            <b>환율</b><span class="mono" id="usdkrw">-</span>
            <b>Upbit KRW</b><span class="mono" id="bal-krw">-</span>
            <b>Upbit BTC</b><span class="mono" id="bal-btc">-</span>
            <b>Binance USDT</b><span class="mono" id="bal-usdt">-</span>
            <b>진입 증거금(USDT)</b><span class="mono" id="used-usdt">-</span>
          </div>
        </div>
        <div class="col-6">
          <div class="spark-wrap">
            <canvas id="spark" class="spark"></canvas>
            <div class="spark-val mono">
              <small>최근 60초 범위</small>
              <div><span id="spark-min">-</span> ~ <span id="spark-max">-</span></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 성과 요약 -->
    <section class="card col-6">
      <h3>성과 요약</h3>
      <div class="grid" style="gap:12px; grid-template-columns: repeat(12, 1fr);">
        <div class="col-6 kv">
          <b>루프</b><span id="metric-loops" class="mono">-</span>
          <b>바이낸스 주문</b><span id="metric-bn" class="mono">-</span>
          <b>업비트 주문</b><span id="metric-up" class="mono">-</span>
          <b>API 오류</b><span id="metric-errors" class="badge bad">-</span>
        </div>
        <div class="col-6 kv">
          <b>실현 손익(누적)</b><span><span id="pnl-krw-sum" class="mono hl">0</span> KRW</span>
          <b>Upbit 수수료(누적)</b><span id="fee-upbit-krw" class="mono">-</span>
          <b>Binance 수수료(USDT)</b><span id="fee-binance-usdt" class="mono">-</span>
          <b>Binance 수수료(KRW)</b><span id="fee-binance-krw" class="mono">-</span>
        </div>
      </div>
    </section>

    <!-- 밴드 보드 -->
    <section class="card col-12">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h3 style="margin:0">밴드 보드</h3>
        <div class="row">
          <button class="btn ghost" id="btn-refresh-bands">서버 동기화</button>
        </div>
      </div>

      <div style="margin-top:10px; overflow:auto; max-height:420px">
        <table id="pos-table">
          <thead>
            <tr>
              <th>id</th>
              <th>상태</th>
              <th>엔트리 김프</th>
              <th>허용오차</th>
              <th>Exit 김프</th>
              <th>Upbit 수량(BTC)</th>
              <th>PnL(KRW)</th>
              <th>액션</th>
            </tr>
          </thead>
          <tbody id="pos-tbody">
            <tr><td colspan="8" class="muted">밴드 없음</td></tr>
          </tbody>
        </table>
      </div>

      <h4 style="margin:14px 0 8px 0; color:#cbd5e1">최근 로그 (상위 300)</h4>
      <div id="log" class="log" aria-live="polite">Loading...</div>
    </section>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
  // ===== Helpers =====
  const $ = sel => document.querySelector(sel);
  const isNum = v => typeof v === 'number' && isFinite(v);
  const fx  = (v, n=2) => isNum(v) ? Number(v).toFixed(n) : '-';
  const loc = v => isNum(v) ? Number(v).toLocaleString() : '-';
  const floorQty = (q)=> Math.floor((Number(q)||0)/0.001)*0.001;

  const UPBIT_TAKER_FEE = 0.0005;

  const DEFAULT_BANDS = [];
  const SPARK_MAX_POINTS = 180;
  let sparkData = [];
  let errCount = 0; const netBadge = $('#net-badge');

  // 전역 가격
  let lastUpbit = NaN, lastBinance = NaN, lastUsdkrw = NaN;

  function setNetBadge(ok, ms=null){
    const dot = netBadge.querySelector('.dot');
    if (dot) dot.className = 'dot ' + (ok ? 'ok' : (errCount ? 'warn' : 'danger'));
    const label = netBadge.querySelector('span');
    if (label) label.textContent = `NET ${ok ? (ms!=null? ms+'ms':'OK') : '…'}`;
  }

  function toast(title, msg='', ok=true){
    const w = document.querySelector('#toasts');
    const el = document.createElement('div');
    el.className = `toast ${ok ? 'ok':'err'}`;
    el.style.cssText = 'position:fixed; right:16px; bottom:16px; background:#0b1320; border:1px solid #1e2a42; padding:10px 12px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); max-width:360px; z-index:60; color:#e2e8f0;';
    el.innerHTML = `<div class="t" style="font-weight:800; margin-bottom:4px">${title}</div><div class="muted" style="font-size:12px; color:#9fb0c9">${msg || ''}</div>`;
    w.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=> w.removeChild(el), 300)}, 3200);
  }

  function drawSpark(){
    const c = $('#spark'); if(!c) return;
    const ctx = c.getContext('2d', { alpha:false });
    const dpr = window.devicePixelRatio || 1;
    const w = c.clientWidth || 300, h = c.clientHeight || 60;
    if (c.width !== w*dpr) c.width = w*dpr;
    if (c.height !== h*dpr) c.height = h*dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,w,h);
    if (!sparkData.length){ return; }
    const min = Math.min(...sparkData), max = Math.max(...sparkData);
    $('#spark-min').textContent = fx(min,2);
    $('#spark-max').textContent = fx(max,2);
    const pad=6; const span = Math.max(1e-9, max-min);
    ctx.beginPath();
    sparkData.forEach((v,i)=>{
      const x = pad + (w-2*pad) * (i/(sparkData.length-1));
      const y = h - pad - (h-2*pad) * ((v-min)/span);
      i? ctx.lineTo(x,y): ctx.moveTo(x,y);
    });
    ctx.lineWidth = 2; ctx.strokeStyle = '#7aa2ff'; ctx.stroke();
  }

  function circleHTML(label, valueText, sizePx){
    return `<div class="circle" style="width:${sizePx}px;height:${sizePx}px">
              <div style="text-align:center">
                <small>${label}</small>
                <strong>${valueText}</strong>
              </div>
            </div>`;
  }

  function updatePreviewForRow(tr){
    const amtInp = tr.querySelector('input[data-k="amount_btc"]');
    const levInp = tr.querySelector('input[data-k="leverage"]');
    const holder = tr.querySelector('[data-size]');
    if (!amtInp || !levInp || !holder) return;

    const qty = floorQty(parseFloat(amtInp.value));
    const lev = Math.max(1, parseInt(levInp.value||'3',10));
    if (!isFinite(qty) || qty<=0 || !isFinite(lastUpbit) || !isFinite(lastBinance)){ holder.innerHTML = '<span class="badge">-</span>'; return; }

    const krwGross = Math.ceil((qty * lastUpbit) / (1 - UPBIT_TAKER_FEE));
    const usdtMargin = (qty * lastBinance) / lev;

    const k = krwGross, u = usdtMargin;
    const kN = k / 1_000_000;
    const uN = u / 100;
    const maxN = Math.max(kN, uN, 0.0001);
    const base = 22, span = 44;
    const kSize = Math.round(base + span * (kN/maxN));
    const uSize = Math.round(base + span * (uN/maxN));

    holder.innerHTML = `<div class="circle-wrap" title="가격과 레버리지에 따라 미리보기가 변합니다.">
      ${circleHTML('Upbit KRW', `${k.toLocaleString()}₩`, kSize)}
      ${circleHTML('Binance USDT', `${usdtMargin.toFixed(2)}$`, uSize)}
    </div>`;
  }

  // ===== 서버 밴드 연동 =====
  function trToBand(tr){
    const get = k=> tr.querySelector(`input[data-k="${k}"]`)?.value ?? '';
    const name = get('name').trim();
    const entry = parseFloat(get('target_kimp'));
    const exit  = parseFloat(get('exit_kimp'));
    const tol   = parseFloat(get('tolerance'));
    const lev   = parseInt(get('leverage')||'3',10);
    const amt   = floorQty(parseFloat(get('amount_btc')));
    return { name, entry_kimp: entry, exit_kimp: exit, tolerance: tol, leverage: lev, amount_btc: amt };
  }

  function setRowState(tr, text, cls=''){
    const s = tr.querySelector('[data-state]');
    if (!s) return;
    s.textContent = text;
    s.className = 'badge' + (cls? ` ${cls}`:'');
  }

  function attachRowServerButtons(tr){
    const addBtn = tr.querySelector('[data-add-server]');
    const cancelBtn = tr.querySelector('[data-cancel-server]');
    addBtn?.addEventListener('click', async ()=>{
      try{
        const band = trToBand(tr);
        if (!band.name || ![band.entry_kimp, band.exit_kimp, band.tolerance, band.leverage, band.amount_btc].every(isFinite)){
          return toast('밴드 입력 오류','빈 칸 또는 숫자 형식 오류가 있습니다.', false);
        }
        const r = await fetch('/bands/add',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
          entry_kimp: band.entry_kimp,
          exit_kimp:  band.exit_kimp,
          tolerance:  band.tolerance,
          leverage:   band.leverage,
          amount_btc: band.amount_btc
        })});
        const j = await r.json().catch(()=>({}));
        if (!r.ok || !j.id){ return toast('서버 추가 실패', j.error||`HTTP ${r.status}`, false); }
        tr.dataset.bid = j.id;
        setRowState(tr, '대기중', 'warn');
        toast('서버 등록 완료', `id=${j.id}`);
        renderServerBands();
      }catch(e){ toast('서버 등록 오류', String(e), false); }
    });

    cancelBtn?.addEventListener('click', async ()=>{
      const id = tr.dataset.bid; if (!id) return toast('취소 실패','이 행은 서버 id가 없습니다.', false);
      try{
        const r = await fetch('/bands/cancel',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})});
        const j = await r.json().catch(()=>({}));
        if (!r.ok){ return toast('취소 실패', j.error||`HTTP ${r.status}`, false); }
        setRowState(tr, '취소 완료', '');
        delete tr.dataset.bid;
        toast('취소됨', id);
        renderServerBands();
      }catch(e){ toast('취소 오류', String(e), false); }
    });
  }

  function renderBands(bands){
    const tb = $('#band-tbody'); tb.innerHTML = '';
    if (!bands.length){ tb.innerHTML = '<tr><td colspan="10" class="muted">밴드를 추가하세요</td></tr>'; return; }
    bands.forEach((b)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="ctrl" value="${b.name ?? ''}" data-k="name"></td>
        <td><input class="ctrl" type="number" step="0.01" value="${b.target_kimp ?? ''}" data-k="target_kimp"></td>
        <td><input class="ctrl" type="number" step="0.01" value="${b.exit_kimp ?? ''}" data-k="exit_kimp"></td>
        <td><input class="ctrl" type="number" step="0.01" value="${b.tolerance ?? 0.1}" data-k="tolerance"></td>
        <td><input class="ctrl" type="number" step="1" value="${b.leverage ?? 3}" data-k="leverage"></td>
        <td><input class="ctrl" type="number" step="0.001" value="${b.amount_btc ?? 0.001}" data-k="amount_btc"></td>
        <td data-size>-</td>
        <td><span class="badge" data-state>-</span></td>
        <td class="pos-actions">
          <div class="row">
            <button class="btn" data-add-server>서버 등록(대기)</button>
            <button class="btn secondary" data-cancel-server title="이 행의 대기 취소">대기 취소</button>
          </div>
        </td>
        <td><button class="btn secondary" data-del>삭제</button></td>`;
      tr.querySelector('[data-del]').addEventListener('click', ()=> tr.remove());
      tr.querySelectorAll('input[data-k]').forEach(inp=> inp.addEventListener('input', ()=> updatePreviewForRow(tr)));
      tb.appendChild(tr);
      updatePreviewForRow(tr);
      attachRowServerButtons(tr);
    });
  }

  function readBands(){
    const rows = Array.from(document.querySelectorAll('#band-tbody tr'));
    const out = [];
    for (const r of rows){
      const inputs = r.querySelectorAll('input[data-k]');
      if (!inputs.length) continue;
      const b = {};
      inputs.forEach(i=>{
        const k = i.dataset.k; let v = i.value;
        if (["target_kimp","exit_kimp","tolerance","leverage","amount_btc"].includes(k)) v = parseFloat(v);
        b[k] = v;
      });
      if (!b.name || ![b.target_kimp,b.exit_kimp,b.tolerance,b.leverage,b.amount_btc].every(isFinite)){
        toast('밴드 입력 오류', '빈 칸 또는 숫자 형식 오류가 있습니다.', false); return null;
      }
      if (b.leverage<1 || b.leverage>50){ toast('레버리지 범위 오류','1~50 사이여야 합니다.', false); return null; }
      if (b.amount_btc<=0){ toast('투자수량 오류','양수 BTC를 입력하세요.', false); return null; }
      b.amount_btc = floorQty(b.amount_btc);
      out.push(b);
    }
    if (!out.length){ toast('밴드 없음','최소 1개 이상 추가하세요.', false); return null; }
    return out;
  }

  // ===== Networking helpers =====
  let aborters = [];
  async function fetchJson(url, opt={}){
    const ctrl = new AbortController(); aborters.push(ctrl);
    const t0 = performance.now();
    const r = await fetch(url, {...opt, signal: ctrl.signal});
    const ms = Math.round(performance.now()-t0); setNetBadge(true, ms);
    if (!r.ok) throw new Error(`${url} ${r.status}`);
    return r.json();
  }
  function cancelInflight(){ aborters.forEach(a=>{try{a.abort();}catch{}}); aborters = []; }
  function onError(e){ errCount++; setNetBadge(false); if (errCount % 5 === 0) toast('네트워크 오류', `일시적 문제 (${errCount}회)`, false); }

  // === 화면 표시: 진입 증거금(USDT)
  function updateUsedMarginFromStatus(s){
    try{
      const el = document.querySelector('#used-usdt');
      if (!el) return;

      const bands = Array.isArray(s?.bands) ? s.bands : [];
      if (!bands.length){ el.textContent = '-'; return; }

      const bp = Number.isFinite(lastBinance) ? lastBinance : NaN;
      if (!Number.isFinite(bp) || bp <= 0){ el.textContent = '-'; return; }

      let used = 0;
      for (const b of bands){
        const st = b?.state;
        const qty = Number(b?.filled_qty || 0);
        const lev = Math.max(1, parseInt(b?.leverage ?? 3, 10));
        if ((st === 'entered' || st === 'hedging') && qty > 0 && Number.isFinite(lev)){
          used += (qty * bp) / lev; // 증거금 = 명목가 / 레버리지
        }
      }
      el.textContent = used > 0 ? used.toFixed(2) : '-';
    }catch(_){ const el = document.querySelector('#used-usdt'); if (el) el.textContent = '-'; }
  }

  // ===== Pollers =====
  async function tickLight(){
    try{
      const k = await fetchJson('/current_kimp');
      const kimp = Number(k.kimp);
      lastUpbit   = Number(k.upbit_price);
      lastBinance = Number(k.binance_price);
      lastUsdkrw  = Number(k.usdkrw);

      $('#kimp').textContent = fx(kimp,2);
      $('#upbit_price').textContent = loc(lastUpbit);
      $('#binance_price').textContent = fx(lastBinance,2);
      $('#usdkrw').textContent = fx(lastUsdkrw,2);
      $('#kimp-brief').textContent = `김프 ${fx(kimp,2)}% · 업비트 ${loc(lastUpbit)} KRW · 바이낸스 ${fx(lastBinance,2)} USDT · 환율 ${fx(lastUsdkrw,2)}`;

      if (isFinite(kimp)){
        sparkData.push(kimp); if (sparkData.length>SPARK_MAX_POINTS) sparkData.shift(); drawSpark();
      }

      const sign = $('#kimp-sign');
      if (isFinite(kimp)){
        if (Math.abs(kimp) < 0.01){ sign.textContent = '중립'; sign.className = 'badge'; }
        else{ sign.textContent = (kimp>=0 ? '프리미엄(+)': '디스카운트(-)'); sign.className = 'badge ' + (kimp>=0?'warn':'good'); }
      }else{ sign.textContent='-'; sign.className='badge'; }

      if (window.__lastStatus) updateUsedMarginFromStatus(window.__lastStatus);

      Array.from(document.querySelectorAll('#band-tbody tr')).forEach(updatePreviewForRow);
    }catch(e){ onError(e); }
  }

  async function renderServerBands(){
    try{
      const s = await fetchJson('/status');
      window.__lastStatus = s;

      const list = Array.isArray(s.bands) ? s.bands : [];
      const tb = $('#pos-tbody'); tb.innerHTML = '';
      if (!list.length){ tb.innerHTML = '<tr><td colspan="8" class="muted">밴드 없음</td></tr>'; }
      list.forEach(b=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${b.id}</td>
          <td><span class="badge ${b.state==='entered'?'good':(b.state==='waiting'?'warn':'')}">${b.state}</span></td>
          <td class="mono">${fx(b.entry_kimp,2)}%</td>
          <td class="mono">±${fx(b.tolerance,2)}</td>
          <td class="mono">${fx(b.exit_kimp,2)}%</td>
          <td class="mono">${fx(b.filled_qty ?? 0,3)}</td>
          <td class="mono">${(b.pnl_krw??0).toLocaleString()}</td>
          <td>
            <div class="row">
              <button class="btn secondary" data-exit>청산</button>
              <button class="btn secondary" data-cancel>대기 취소</button>
            </div>
          </td>`;
        tr.querySelector('[data-exit]')?.addEventListener('click', async ()=>{
          try{
            const r = await fetch('/bands/force_exit',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id: b.id})});
            const j = await r.json().catch(()=>({}));
            if (!r.ok){ return toast('청산 실패', j.error||`HTTP ${r.status}`, false); }
            toast('청산 요청 완료', b.id);
            renderServerBands();
          }catch(e){ toast('청산 오류', String(e), false); }
        });
        tr.querySelector('[data-cancel]')?.addEventListener('click', async ()=>{
          try{
            const r = await fetch('/bands/cancel',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id: b.id})});
            const j = await r.json().catch(()=>({}));
            if (!r.ok){ return toast('취소 실패', j.error||`HTTP ${r.status}`, false); }
            toast('대기 취소', b.id);
            renderServerBands();
          }catch(e){ toast('취소 오류', String(e), false); }
        });
        tb.appendChild(tr);
      });

      $('#log').textContent = (s.logs||[]).join('\n');
      $('#pnl-krw-sum').textContent = (s.pnl?.profit_krw_cum ?? 0).toLocaleString();
      $('#fee-upbit-krw').textContent = (s.pnl?.fees_upbit_krw_cum ?? 0).toLocaleString();
      $('#fee-binance-usdt').textContent = (s.pnl?.fees_binance_usdt_cum ?? 0).toFixed(3);
      $('#fee-binance-krw').textContent = (s.pnl?.fees_binance_krw_cum ?? 0).toLocaleString();

      const run = !!s.running; const runDot = $('#run-badge .dot');
      if (runDot) runDot.className = 'dot ' + (run?'ok':'danger');
      $('#run-badge span:last-child').textContent = run ? '실행중' : '중지';

      updateUsedMarginFromStatus(s);
    }catch(e){ onError(e); }
  }

  async function tickBalance(){
    try{
      const b = await fetchJson('/balance');
      const N = v => { const n = Number(v); return Number.isFinite(n) ? n : NaN; };
      const krw = N(b?.real?.krw) ?? N(b?.upbit_krw) ?? N(b?.upbit?.krw) ?? N(b?.upbit?.balances?.KRW) ?? N(b?.balances?.upbit?.KRW) ?? N(b?.krw_balance);
      const btcUpbit = N(b?.real?.btc_upbit) ?? N(b?.upbit_btc) ?? N(b?.upbit?.btc) ?? N(b?.upbit?.balances?.BTC) ?? N(b?.balances?.upbit?.BTC);
      const usdt = N(b?.real?.usdt) ?? N(b?.binance_usdt) ?? N(b?.binance?.usdt) ?? N(b?.binance?.spot?.USDT) ?? N(b?.balances?.binance?.USDT) ?? N(b?.binance?.wallets?.spot?.USDT) ?? N(b?.binance?.futures?.USDT) ?? N(b?.futures_usdt);
      $('#bal-krw').textContent  = Number.isFinite(krw)     ? krw.toLocaleString() : '-';
      $('#bal-btc').textContent  = Number.isFinite(btcUpbit) ? btcUpbit.toFixed(6)  : '-';
      $('#bal-usdt').textContent = Number.isFinite(usdt)     ? usdt.toFixed(3)      : '-';
    }catch(e){ onError(e); }
  }

  async function tickMetrics(){
    try{
      const m = await fetchJson('/metrics');
      $('#metric-loops').textContent  = m.loops ?? '-';
      $('#metric-bn').textContent     = m.orders_binance ?? '-';
      $('#metric-up').textContent     = m.orders_upbit ?? '-';
      $('#metric-errors').textContent = m.api_errors ?? '-';
    }catch(e){ onError(e); }
  }

  // ====== 실시간 김프 (WS) ======
  let upbitWS = null, binanceWS = null;

  function updateKimpAndUIFromTicks() {
    if (!Number.isFinite(lastUpbit) || !Number.isFinite(lastBinance) || !Number.isFinite(lastUsdkrw)) return;
    const kimp = ((lastUpbit - lastBinance * lastUsdkrw) / (lastBinance * lastUsdkrw)) * 100.0;

    $('#kimp').textContent = fx(kimp, 2);
    $('#upbit_price').textContent = loc(lastUpbit);
    $('#binance_price').textContent = fx(lastBinance, 2);

    const sign = $('#kimp-sign');
    if (Math.abs(kimp) < 0.01) { sign.textContent = '중립'; sign.className = 'badge'; }
    else { sign.textContent = (kimp>=0 ? '프리미엄(+)': '디스카운트(-)'); sign.className = 'badge ' + (kimp>=0?'warn':'good'); }

    $('#kimp-brief').textContent = `김프 ${fx(kimp,2)}% · 업비트 ${loc(lastUpbit)} KRW · 바이낸스 ${fx(lastBinance,2)} USDT · 환율 ${fx(lastUsdkrw,2)}`;

    sparkData.push(kimp);
    if (sparkData.length > SPARK_MAX_POINTS) sparkData.shift();
    drawSpark();

    if (window.__lastStatus) updateUsedMarginFromStatus(window.__lastStatus);
  }

  function connectUpbitWS() {
    try { upbitWS && upbitWS.close(); } catch {}
    upbitWS = new WebSocket('wss://api.upbit.com/websocket/v1');
    upbitWS.binaryType = 'arraybuffer';
    upbitWS.onopen = () => {
      const msg = [
        { ticket: 'kimp-dashboard' },
        { type: 'ticker', codes: ['KRW-BTC'] }
      ];
      upbitWS.send(JSON.stringify(msg));
    };
    upbitWS.onmessage = (ev) => {
      try {
        const data = msgpack.decode(new Uint8Array(ev.data));
        const p = Number(data?.trade_price);
        if (Number.isFinite(p) && p > 0) {
          lastUpbit = p;
          updateKimpAndUIFromTicks();
        }
      } catch(_){}}
    upbitWS.onclose = () => setTimeout(connectUpbitWS, 1500);
    upbitWS.onerror = () => { try { upbitWS.close(); } catch {} };
  }

  function connectBinanceWS() {
    try { binanceWS && binanceWS.close(); } catch {}
    binanceWS = new WebSocket('wss://fstream.binance.com/ws/btcusdt@aggTrade');
    binanceWS.onmessage = (ev) => {
      try {
        const j = JSON.parse(ev.data);
        const p = Number(j?.p);
        if (Number.isFinite(p) && p > 0) {
          lastBinance = p;
          updateKimpAndUIFromTicks();
        }
      } catch(_){}}
    binanceWS.onclose = () => setTimeout(connectBinanceWS, 1500);
    binanceWS.onerror = () => { try { binanceWS.close(); } catch {} };
  }

  function startRealtime() {
    connectUpbitWS();
    connectBinanceWS();
  }

  // ===== Actions =====
  $('#btn-add-band').addEventListener('click', ()=>{
    const tb = document.querySelector('#band-tbody');
    const keep = Array.from(tb.querySelectorAll('tr')).map(tr=>{
      const val = k => tr.querySelector(`input[data-k="${k}"]`)?.value ?? '';
      const f   = v => { const n = parseFloat(v); return isFinite(n) ? n : ''; };
      return {
        name: val('name'),
        target_kimp: f(val('target_kimp')),
        exit_kimp:   f(val('exit_kimp')),
        tolerance:   f(val('tolerance')),
        leverage:    f(val('leverage')),
        amount_btc:  f(val('amount_btc')),
      };
    });
    const idx = keep.length + 1;
    keep.push({ name:`B${idx}`, target_kimp:0, exit_kimp:0.2, tolerance:0.1, leverage:3, amount_btc:0.001 });
    renderBands(keep);
  });

  $('#btn-save').addEventListener('click', ()=>{
    const bands = readBands(); if (!bands) return;
    localStorage.setItem('kimp_cfg_bands_v2', JSON.stringify({bands}));
    toast('설정 저장 완료','브라우저 로컬에 저장되었습니다.');
  });

  $('#btn-load').addEventListener('click', ()=>{
    const raw = localStorage.getItem('kimp_cfg_bands_v2');
    if (!raw) return toast('불러올 설정 없음','먼저 저장해주세요.', false);
    try{ const j=JSON.parse(raw); renderBands(j.bands ?? []); toast('설정 불러옴','입력값에 적용되었습니다.'); }
    catch(e){ toast('불러오기 실패', String(e), false); }
  });

  $('#btn-start').addEventListener('click', async ()=>{
    try{
      const resp = await fetch('/start',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({}) });
      const j = await resp.json().catch(()=>({}));
      if (!resp.ok){ toast('시작 실패', (j.error||`HTTP ${resp.status}`), false); return; }
      toast('전략 시작','엔진이 실행되었습니다.');
      renderServerBands();
    }catch(e){ onError(e); toast('시작 실패', String(e), false); }
  });

  $('#btn-stop').addEventListener('click', async ()=>{
    try{ await fetch('/stop',{method:'POST'}); toast('전략 중지','전략 스레드를 종료합니다.'); renderServerBands(); }
    catch(e){ onError(e); toast('중지 실패', String(e), false); }
  });

  $('#btn-refresh-bands').addEventListener('click', renderServerBands);

  // ===== Polling lifecycle =====
  let idLight, idStatus, idBal, idMet;
  function startPolling(){
    stopPolling();
    idLight=setInterval(tickLight,350);
    idStatus=setInterval(renderServerBands,900);
    idBal=setInterval(tickBalance,2500);
    idMet=setInterval(tickMetrics,2500);
    tickLight(); renderServerBands(); tickBalance(); tickMetrics();
    window.addEventListener('resize', drawSpark);
  }
  function stopPolling(){
    [idLight,idStatus,idBal,idMet].forEach(id=>id&&clearInterval(id));
    idLight=idStatus=idBal=idMet=null;
    cancelInflight();
  }
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden){ stopPolling(); } else { startPolling(); drawSpark(); } });

  // ===== init =====
  (function init(){
    const raw = localStorage.getItem('kimp_cfg_bands_v2');
    if (raw){
      try{ const j=JSON.parse(raw); renderBands(j.bands ?? DEFAULT_BANDS); }
      catch{ renderBands(DEFAULT_BANDS); }
    }else{ renderBands(DEFAULT_BANDS); }
    startPolling();   // 폴링(환율/상태/로그/백업)
    startRealtime();  // 실시간 김프(업비트/바이낸스 WS)
  })();
</script>
</body>
</html>
