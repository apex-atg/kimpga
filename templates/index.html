<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>김프 자동매매 · Flip Mode</title>
<meta name="color-scheme" content="dark">
<style>
  :root{--bg:#0b0f17;--panel:#0f1522;--panel2:#0c1320;--text:#e7ecf5;--muted:#98a3b7;
        --primary:#00e0c7;--primary2:#14b8a6;--accent:#7aa2ff;--danger:#ff5570;--warn:#ffb020;--ok:#22c55e;--border:#1b2536;}
  *{box-sizing:border-box}
  body{margin:0;color:var(--text);background:linear-gradient(180deg,#0a0e16,var(--bg));
       font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Noto Sans KR','Noto Sans',sans-serif}
  header{position:sticky;top:0;z-index:40;background:rgba(8,12,20,.65);backdrop-filter:blur(10px) saturate(160%);border-bottom:1px solid var(--border)}
  .nav{max-width:1220px;margin:0 auto;padding:12px 18px;display:flex;gap:12px;align-items:center}
  .chip{border:1px solid var(--border);background:#0a1220;border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1;display:inline-flex;gap:8px;align-items:center}
  .dot{width:7px;height:7px;border-radius:50%;background:#94a3b8}.ok{background:var(--ok)}.warn{background:var(--warn)}.bad{background:var(--danger)}
  .wrap{max-width:1220px;margin:22px auto;padding:0 18px}
  .grid{display:grid;gap:18px;grid-template-columns:repeat(12,1fr)}
  .col-4{grid-column:span 4}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
  @media(max-width:1024px){.col-4,.col-8{grid-column:span 12}}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:14px;padding:18px}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  .ctrl{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1e293b;background:#0b1220;color:#dbe6ff}
  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;color:#051018;background:linear-gradient(135deg,var(--primary),var(--primary2))}
  .btn.secondary{background:#122036;color:#e2e8f0;border:1px solid #22324b}
  .btn.ghost{background:transparent;border:1px dashed #334155;color:#a9b4c7}
  .btn.small{padding:6px 10px;font-weight:700;border-radius:10px}
  .kv{display:grid;grid-template-columns:150px 1fr;gap:6px}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono,Menlo,Consolas,monospace}
  .badge{border:1px solid var(--border);padding:3px 8px;border-radius:999px;font-size:12px;background:#0b1320}
  .spark{width:100%;height:54px;display:block;background:#0a1220;border:1px solid #1b2a3b;border-radius:10px}
  .log{height:340px;overflow:auto;background:#05080f;border:1px solid #1b2a3b;border-radius:10px;color:#9ff3ad;padding:12px;font:12px/1.5 ui-monospace,SFMono,Menlo,Consolas,monospace}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1b2536;padding:8px;font-size:13px}
  .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px}
  .toast{min-width:240px;max-width:360px;background:#0e1728;border:1px solid #20304b;border-radius:12px;padding:10px 12px}
  .chipset{display:flex;flex-wrap:wrap;gap:8px}
  .chip.act{cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="nav">
    <div class="chip"><span class="dot" id="run-dot"></span><span id="run-text">상태 확인중…</span></div>
    <div class="chip"><span class="dot ok"></span>0.35s Price · 30s FX</div>
    <div class="chip" id="net-chip"><span class="dot"></span><span>NET …</span></div>
    <div class="chip" title="이 UI는 단일 포지션 전환(Flip)만 지원합니다.">MODE: <b style="margin-left:6px;color:#9ee7ff">FLIP</b></div>
    <div style="flex:1"></div>
    <div id="kimp-brief" class="mono">-</div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- 좌: 설정 (FLIP 전용) -->
    <section class="card col-4">
      <h3>전략 설정 (Flip)</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div><label>목표 김프(%)</label><input id="target_kimp" class="ctrl" type="number" step="0.01" value="0.30"></div>
        <div><label>청산 김프(%)</label><input id="exit_kimp" class="ctrl" type="number" step="0.01" value="0.60" placeholder="비우면 자동 ±0.3p"></div>
        <div><label>오차 허용(%)</label><input id="tolerance" class="ctrl" type="number" step="0.01" value="0.05"></div>
        <div><label>레버리지</label><input id="leverage" class="ctrl" type="number" step="1" value="3"></div>
      </div>

      <div style="margin-top:8px">
        <label>진입 금액 (KRW)</label>
        <input id="amount_krw" class="ctrl mono" type="number" step="1000" value="1000000">
      </div>

      <fieldset style="margin-top:12px;border:1px dashed var(--border);border-radius:12px;padding:10px">
        <legend style="color:#98a3b7">플립 제어</legend>
        <label><input type="checkbox" id="exit_on_sign_change" checked> 부호 전환 시 즉시 청산</label>
        <div><label>엔트리 대비 변동폭으로 청산(%p)</label>
          <input id="exit_on_move_bp" class="ctrl" type="number" step="0.1" value="0"></div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="btn-start" class="btn">▶ 시작(단일)</button>
          <button id="btn-stop" class="btn secondary">■ 중지</button>
          <button id="btn-force-exit" class="btn ghost">즉시 청산</button>
          <button id="btn-flip-start" class="btn">FLIP: 청산→새 타깃 시작</button>
          <button id="btn-manual-enter" class="btn secondary">수동 진입(지금, 플립)</button>
        </div>
      </fieldset>

      <!-- 사용자 프리셋 -->
      <fieldset style="margin-top:12px;border:1px dashed var(--border);border-radius:12px;padding:10px">
        <legend style="color:#98a3b7">프리셋 (사용자 설정)</legend>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div><label>프리셋 Target %</label><input id="p_target" class="ctrl" type="number" step="0.01" placeholder="예: 0.30"></div>
          <div><label>프리셋 Exit %</label><input id="p_exit" class="ctrl" type="number" step="0.01" placeholder="예: 0.60 (비우면 자동)"></div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="preset-apply-edit" class="btn small">에디트값 적용</button>
          <button id="preset-copy-from-fields" class="btn small ghost">현재 필드값 → 에디트</button>
          <select id="preset-slot" class="ctrl" style="width:auto;padding:6px 10px">
            <option value="0">슬롯 1</option><option value="1">슬롯 2</option><option value="2">슬롯 3</option>
            <option value="3">슬롯 4</option><option value="4">슬롯 5</option>
          </select>
          <button id="preset-save" class="btn small secondary">슬롯 저장</button>
        </div>
        <div id="preset-list" class="chipset" style="margin-top:8px"></div>
        <div style="font-size:12px;color:#98a3b7;margin-top:6px">
          * 슬롯을 눌러 바로 적용할 수 있습니다. (브라우저에 저장됨)
        </div>
      </fieldset>

      <div style="margin-top:10px" class="kv">
        <b>목표 사이즈</b><span><span id="target_size_usdt" class="mono">-</span> USDT</span>
        <b>필요 증거금</b><span><span id="required_margin" class="mono">-</span> USDT</span>
        <b>상태</b><span id="status-text" class="badge">-</span>
        <b>포지션</b><span id="position" class="badge">-</span>
      </div>
    </section>

    <!-- 우: 스냅샷 + 레그/로그 -->
    <section class="card col-8">
      <h3>시장 스냅샷</h3>
      <div class="grid" style="gap:12px;grid-template-columns:repeat(12,1fr)">
        <div class="col-4">
          <div class="kv">
            <b>김프</b><span><span id="kimp" class="mono" style="font-weight:800">-</span> <span id="kimp-sign" class="badge">-</span></span>
            <b>업비트</b><span id="upbit_price" class="mono">-</span>
            <b>바이낸스</b><span id="binance_price" class="mono">-</span>
            <b>환율</b><span id="usdkrw" class="mono">-</span>
            <b>Upbit KRW</b><span id="bal-krw" class="mono">-</span>
            <b>Upbit BTC</b><span id="bal-btc" class="mono">-</span>
            <b>Binance USDT</b><span id="bal-usdt" class="mono">-</span>
          </div>
        </div>
        <div class="col-8">
          <canvas id="spark" class="spark"></canvas>
          <div style="display:flex;justify-content:space-between;font-size:12px;color:#98a3b7;margin-top:6px">
            <span>최근 60초</span><span class="mono"><span id="spark-min">-</span> ~ <span id="spark-max">-</span></span>
          </div>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid var(--border);margin:14px 0"/>

      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">오픈 레그 (최대 1개: Flip)</h3>
        <div class="mono" id="legs-summary">0 legs</div>
      </div>
      <div style="overflow:auto">
        <table id="legs-table">
          <thead>
            <tr><th>ID</th><th>Entry %</th><th>Exit %</th><th>Upbit BTC</th><th>Binance BTC</th><th>진입시각</th><th>액션</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <hr style="border:none;border-top:1px solid var(--border);margin:14px 0"/>

      <div class="grid" style="gap:12px;grid-template-columns:repeat(12,1fr)">
        <div class="col-6 kv">
          <b>총 거래수</b><span id="count" class="mono">0</span>
          <b>누적 손익</b><span><span id="krw" class="mono">0</span> KRW</span>
          <b>직전 손익</b><span><span id="last-krw" class="mono">0</span> KRW</span>
          <b>직전 ROI(레그 기준)</b><span><span id="pnl" class="mono">0.000</span> %</span>
        </div>
        <div class="col-6">
          <div class="log" id="log">Loading…</div>
        </div>
      </div>
    </section>

    <section class="card col-12">
      <div class="kv">
        <b>루프</b><span id="metric-loops" class="mono">-</span>
        <b>BIN 주문</b><span id="metric-bn" class="mono">-</span>
        <b>UP 주문</b><span id="metric-up" class="mono">-</span>
        <b>API 오류</b><span id="metric-errors" class="mono">-</span>
      </div>
    </section>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
const $=s=>document.querySelector(s);
const N=v=>typeof v==='number'&&isFinite(v);
const fx=(v,n=2)=>N(v)?Number(v).toFixed(n):'-';
const loc=v=>N(v)?Number(v).toLocaleString():'-';
const toast=(t,m='',ok=true)=>{const w=$('#toasts');const el=document.createElement('div');el.className='toast';el.innerHTML=`<b>${t}</b><div style="color:#9fb5d1">${m}</div>`;w.appendChild(el);setTimeout(()=>{el.style.opacity='0';setTimeout(()=>w.removeChild(el),300)},3000);};

let spark=[], inflight={k:false,s:false};
const PRESET_KEY='flip_presets_v1'; // [{t:0.3,e:0.6}, ...]

/* ---------- helpers ---------- */
async function j(url,opt={}){
  const t0=performance.now();
  const r=await fetch(url,opt);
  const ms=Math.round(performance.now()-t0);
  const chip=$('#net-chip');
  chip.querySelector('span').textContent=`NET ${r.ok?ms+'ms':'…'}`;
  chip.querySelector('.dot').className='dot '+(r.ok?'ok':'bad');
  if(!r.ok) throw new Error(url+' '+r.status);
  return r.json();
}
const loadPresets=()=>{ try{ return JSON.parse(localStorage.getItem(PRESET_KEY)||'[]'); }catch(_){ return []; } };
const savePresets=(arr)=>{ localStorage.setItem(PRESET_KEY, JSON.stringify(arr)); renderPresetChips(); };

function drawSpark(){
  const c=$('#spark'); if(!c||!spark.length) return;
  const dpr=window.devicePixelRatio||1, w=c.clientWidth,h=c.clientHeight;
  if(c.width!==w*dpr) c.width=w*dpr; if(c.height!==h*dpr) c.height=h*dpr;
  const ctx=c.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.clearRect(0,0,w,h);
  const min=Math.min(...spark), max=Math.max(...spark), pad=6, span=Math.max(1e-9,max-min);
  ctx.beginPath();
  spark.forEach((v,i)=>{const x=pad+(w-2*pad)*(i/(spark.length-1)); const y=h-pad-(h-2*pad)*((v-min)/span); i?ctx.lineTo(x,y):ctx.moveTo(x,y);});
  ctx.lineWidth=2; ctx.strokeStyle='#7aa2ff'; ctx.stroke();
  $('#spark-min').textContent=fx(min,2); $('#spark-max').textContent=fx(max,2);
}

function applyCalcExtras(k){
  const kimp=Number(k.kimp), up=Number(k.upbit_price), bp=Number(k.binance_price), usdk=Number(k.usdkrw);
  $('#kimp').textContent=fx(kimp,2); $('#upbit_price').textContent=loc(up); $('#binance_price').textContent=fx(bp,2); $('#usdkrw').textContent=fx(usdk,2);
  $('#kimp-brief').textContent=`김프 ${fx(kimp,2)}% · 업비트 ${loc(up)} KRW · 바이낸스 ${fx(bp,2)} USDT · 환율 ${fx(usdk,2)}`;
  if(N(kimp)){ spark.push(kimp); if(spark.length>180) spark.shift(); drawSpark(); }
  const sign=$('#kimp-sign'); sign.textContent = Math.abs(kimp)<0.01 ? '중립' : (kimp>=0?'프리미엄(+)':'디스카운트(-)');
  const amt=Number($('#amount_krw').value)||0, lev=Number($('#leverage').value)||1;
  const size=usdk>0?amt/usdk:0, margin=lev>0?size/lev:0; $('#target_size_usdt').textContent=fx(size,2); $('#required_margin').textContent=fx(margin,2);
}

function renderLegs(s){
  const legs=s.open_legs||[];
  $('#legs-summary').textContent=`${legs.length} legs open`;
  const tb=$('#legs-table tbody'); tb.innerHTML='';
  legs.forEach(l=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="mono">${l.id}</td>
      <td class="mono">${fx(l.entry_kimp,4)}</td>
      <td class="mono">${fx(l.exit_kimp,4)}</td>
      <td class="mono">${Number(l.upbit_qty||0).toFixed(3)}</td>
      <td class="mono">${Number(l.binance_qty||0).toFixed(3)}</td>
      <td>${new Date((l.entered_at||0)*1000).toLocaleString()}</td>
      <td><button class="btn ghost" data-close="${l.id}">청산</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-close]').forEach(b=>{
    b.addEventListener('click', async ()=>{
      const id=Number(b.dataset.close);
      try{
        const r=await fetch('/close_leg',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})});
        const j=await r.json().catch(()=>({}));
        if(r.ok&&j.ok){ toast('레그 청산','ID '+id); tickStatus(); }
        else { toast('청산 실패', JSON.stringify(j), false); }
      }catch(e){ toast('청산 오류', String(e), false); }
    });
  });
}

/* --------- preset UI ---------- */
function renderPresetChips(){
  const list=$('#preset-list'); list.innerHTML='';
  const arr=loadPresets();
  for(let i=0;i<5;i++){
    const p=arr[i]; const el=document.createElement('div');
    el.className='chip act';
    if(p){
      el.innerHTML=`슬롯 ${i+1}: <span class="mono">${(p.t??'—')} → ${(p.e??'—')}</span>
        <button data-apply="${i}" class="btn small secondary">적용</button>
        <button data-del="${i}" class="btn small ghost">삭제</button>`;
    }else{
      el.style.opacity='0.7';
      el.textContent=`슬롯 ${i+1}: (비어있음)`;
    }
    list.appendChild(el);
  }
  list.querySelectorAll('[data-apply]').forEach(b=>{
    b.addEventListener('click',()=>{
      const idx=Number(b.dataset.apply); const p=loadPresets()[idx]; if(!p) return;
      if(p.t!==undefined) $('#target_kimp').value=p.t;
      if(p.e!==undefined) $('#exit_kimp').value=(p.e===null?'':p.e);
      toast('프리셋 적용', `슬롯 ${idx+1}`);
    });
  });
  list.querySelectorAll('[data-del]').forEach(b=>{
    b.addEventListener('click',()=>{
      const idx=Number(b.dataset.del); const arr=loadPresets(); arr[idx]=undefined; savePresets(arr);
      toast('프리셋 삭제', `슬롯 ${idx+1}`);
    });
  });
}

/* --------- polling ---------- */
async function tickLight(){ if(inflight.k) return; inflight.k=true;
  try{ const k=await j('/current_kimp'); applyCalcExtras(k); }catch(e){} finally{ inflight.k=false; }
}
async function tickStatus(){ if(inflight.s) return; inflight.s=true;
  try{
    const s=await j('/status'); const run=!!s.running;
    $('#run-text').textContent=run?'Running':'Stopped'; $('#run-dot').className='dot '+(run?'ok':'bad');
    $('#status-text').textContent=run?'실행중':'중지됨'; $('#position').textContent=s.position_state||'-';
    $('#count').textContent=s.trade_count??0;
    const p=s.pnl||{}; $('#krw').textContent=(p.profit_krw_cum??0).toLocaleString();
    const last=s.last_closed_leg||null;
    const lastKrw = last && N(Number(last.realized_krw)) ? Number(last.realized_krw) : 0;
    const lastRoi = last && N(Number(last.roi_pct)) ? Number(last.roi_pct) : 0;
    $('#last-krw').textContent=lastKrw.toLocaleString();
    $('#pnl').textContent=fx(lastRoi,3);
    const L=Array.isArray(s.logs)?s.logs:[]; const el=$('#log'); el.textContent=L.join('\n'); el.scrollTop=el.scrollHeight;
    renderLegs(s);
  }catch(e){} finally{ inflight.s=false; }
}
async function tickHeavy(){
  try{
    const b=await j('/balance');
    if(b&&b.real){
      $('#bal-krw').textContent=(b.real.krw??0).toLocaleString();
      $('#bal-btc').textContent=(b.real.btc_upbit??0).toFixed(6);
      $('#bal-usdt').textContent=(b.real.usdt??0).toFixed(3);
    }
    const m=await j('/metrics');
    if(m){
      $('#metric-loops').textContent=m.loops??'-';
      $('#metric-bn').textContent=m.orders_binance??'-';
      $('#metric-up').textContent=m.orders_upbit??'-';
      $('#metric-errors').textContent=m.api_errors??'-';
    }
  }catch(e){}
}

/* --------- actions (FLIP) ---------- */
function buildCfg(){
  const cfg={
    target_kimp: parseFloat($('#target_kimp').value),
    tolerance: parseFloat($('#tolerance').value),
    amount_krw: parseFloat($('#amount_krw').value),
    leverage: parseInt($('#leverage').value,10),
    allow_multi_entry: false,
    max_legs: 1,
    min_reenter_gap_bp: 9.99,
    exit_on_sign_change: $('#exit_on_sign_change').checked,
    exit_on_move_bp: parseFloat($('#exit_on_move_bp').value)
  };
  const exitVal=parseFloat($('#exit_kimp').value);
  if(!Number.isNaN(exitVal)) cfg.exit_kimp=exitVal; // 비우면 서버가 자동 ±0.3p
  return cfg;
}
async function startStrategy(){
  const cfg=buildCfg();
  try{
    const r=await fetch('/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(cfg)});
    const j=await r.json().catch(()=>({}));
    if(!r.ok) return toast('시작 실패', JSON.stringify(j||r.status), false);
    toast('전략 시작','Flip 단일 모드');
  }catch(e){ toast('시작 실패', String(e), false); }
}
async function stopStrategy(){ try{ await fetch('/stop',{method:'POST'}); toast('전략 중지'); }catch(e){ toast('중지 실패', String(e), false);} }
async function forceExit(){
  try{
    const r=await fetch('/force_exit',{method:'POST'});
    const j=await r.json().catch(()=>({}));
    toast('즉시 청산', `닫힌 레그 ${j.closed_count??0}`); tickStatus();
  }catch(e){ toast('즉시 청산 실패', String(e), false); }
}
async function flipStart(){ try{ await forceExit(); await startStrategy(); }catch(e){} }
async function manualEnterFlip(){
  const amount = parseFloat($('#amount_krw').value);
  const lev = parseInt($('#leverage').value,10);
  const exitVal = parseFloat($('#exit_kimp').value);
  const body = { amount_krw: amount, leverage: lev };
  if(!Number.isNaN(exitVal)) body.exit_kimp = exitVal;
  try{
    await forceExit();
    const r = await fetch('/manual_enter',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    const j = await r.json().catch(()=>({}));
    if(r.ok && j.ok){ toast('수동 진입 성공', `레그 ID ${j.leg?.id ?? ''}`); tickStatus(); }
    else{ toast('수동 진입 실패', (j && (j.error||JSON.stringify(j))) || r.status, false); }
  }catch(e){ toast('수동 진입 오류', String(e), false); }
}

/* preset actions */
function presetApplyEdit(){
  const t = parseFloat($('#p_target').value);
  const eRaw = $('#p_exit').value.trim();
  const e = eRaw==='' ? null : parseFloat(eRaw);
  if(!Number.isNaN(t)) $('#target_kimp').value=t;
  if(eRaw==='') $('#exit_kimp').value=''; else if(!Number.isNaN(e)) $('#exit_kimp').value=e;
  toast('에디트값 적용', `${t} → ${eRaw===''?'(자동)':e}`);
}
function presetCopyFromFields(){
  $('#p_target').value=$('#target_kimp').value;
  $('#p_exit').value=$('#exit_kimp').value;
}
function presetSave(){
  const slot=parseInt($('#preset-slot').value,10);
  const t=parseFloat($('#p_target').value);
  const eRaw=$('#p_exit').value.trim();
  const e=eRaw===''?null:parseFloat(eRaw);
  if(Number.isNaN(t)) return toast('저장 실패','Target %를 입력하세요',false);
  if(eRaw!=='' && Number.isNaN(e)) return toast('저장 실패','Exit % 입력 오류',false);
  const arr=loadPresets();
  arr[slot]={t: t, e: (eRaw===''?null:e)};
  savePresets(arr);
  toast('프리셋 저장', `슬롯 ${slot+1} : ${t} → ${eRaw===''?'(자동)':e}`);
}

/* init */
document.getElementById('btn-start').addEventListener('click', startStrategy);
document.getElementById('btn-stop').addEventListener('click', stopStrategy);
document.getElementById('btn-force-exit').addEventListener('click', forceExit);
document.getElementById('btn-flip-start').addEventListener('click', flipStart);
document.getElementById('btn-manual-enter').addEventListener('click', manualEnterFlip);

document.getElementById('preset-apply-edit').addEventListener('click', presetApplyEdit);
document.getElementById('preset-copy-from-fields').addEventListener('click', presetCopyFromFields);
document.getElementById('preset-save').addEventListener('click', presetSave);

renderPresetChips();
setInterval(tickLight,350);
setInterval(tickStatus,900);
setInterval(tickHeavy,2500);
tickLight(); tickStatus(); tickHeavy(); window.addEventListener('resize', drawSpark);
</script>
</body>
</html>
